AWSTemplateFormatVersion: 2010-09-09
Description: CloudFormation Template for WebServer with Security Group and EC2 Instance

Parameters:
  FoundationStack: 
    Type: String

  StateStack:
    Type: String

  FileSystemResource: 
    Type: String

  DatabaseHostname:
    Type: String

  DatabaseRootUser:
    Type: String
    Default: 'root'

  DatabaseRootPassword:
    Type: String
    Default: Password0

  WordpressDatabase:
    Type: String
    Default: wordpress

  WordpressDatabaseUser:
    Type: String
    Default: wordpress

  WordpressDatabasePassword:
    Type: String
    Default: Password0

  WordpressHostname:
    Type: String
    Default: ""

  AppSecurityGroup:
    Type: String

  LoadBalancerSecurityGroup:
    Type: String

  VpcId:
    Type: String

  LatestAmiId:
    Description: The latest Amazon Linux 2023 AMI from the Parameter Store
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64

  InstanceType:
    Description: WebServer EC2 instance type
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.medium
    ConstraintDescription: must be a valid EC2 instance type.

  SubnetA:
    Type: AWS::EC2::Subnet::Id
    Description: First subnet for ALB
  
  SubnetB:
    Type: AWS::EC2::Subnet::Id
    Description: Second subnet for ALB (must be in different AZ)

  PreferredSubnet:
    Type: String
    Default: A
    AllowedValues: [A, B]

Conditions:
  UseSubnetA: !Equals [!Ref PreferredSubnet, A]

Resources:
  WebServer:
    Type: AWS::EC2::Instance
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-Server
      ImageId: !Ref LatestAmiId
      IamInstanceProfile: !Ref InstanceProfile
      InstanceType: !Ref InstanceType
      SubnetId: !If [UseSubnetA, !Ref SubnetB, !Ref SubnetA]
      SecurityGroupIds:
        - !Ref AppSecurityGroup
      UserData: !Base64
        Fn::Sub: |-
          #!/bin/bash
          dnf update -y
          dnf install -y amazon-efs-utils docker mariadb1011-client-utils
      
          mysql -h${DatabaseHostname} -u${DatabaseRootUser} -p${DatabaseRootPassword} <<EOF
          CREATE DATABASE IF NOT EXISTS ${WordpressDatabase};
          CREATE USER IF NOT EXISTS '${WordpressDatabaseUser}'@'%' IDENTIFIED BY '${WordpressDatabasePassword}';
          GRANT ALL PRIVILEGES ON ${WordpressDatabase}.* TO '${WordpressDatabaseUser}'@'%';
          FLUSH PRIVILEGES;
          EOF

          useradd -m -u 1100 wordpress
          usermod -aG docker wordpress
          su wordpress -c 'mkdir -p /home/wordpress/{wp-data,data_backups}'
          echo "${FileSystemResource}:/ /home/wordpress/wp-data efs _netdev,tls,iam 0 0" >> /etc/fstab
          mount -a
          systemctl enable --now docker
          su wordpress -c bash <<'EOF'
          docker run -d \
            --name wordpress \
            --restart always \
            -v "/home/wordpress/wp-data:/var/www/html" \
            -v "/home/wordpress/data_backups:/var/tmp/backups" \
            -p 80:80 \
            -e WORDPRESS_CONFIG_EXTRA="define( 'WP_HOME', \"http://${ElasticLoadBalancer.DNSName}\" ); define( 'WP_SITEURL', \"http://${ElasticLoadBalancer.DNSName}\");" \
            -e WORDPRESS_DB_HOST=${DatabaseHostname} \
            -e WORDPRESS_DB_USER=${WordpressDatabaseUser} \
            -e WORDPRESS_DB_PASSWORD=${WordpressDatabasePassword} \
            -e WORDPRESS_DB_NAME=${WordpressDatabase} \
            wordpress:6.9.0-apache
          EOF
          #  Signal success to CloudFormation
     #     /opt/aws/bin/cfn-signal -e $? \
     #       --stack ${AWS::StackName} \
     #       --resource WebServer \
     #       --region ${AWS::Region}
    #CreationPolicy:
    #  ResourceSignal:
    #    Count: 1
    #    Timeout: PT15M

  ElasticLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internet-facing
      Subnets:
        - !Ref SubnetA
        - !Ref SubnetB
      SecurityGroups:
        - !Ref LoadBalancerSecurityGroup
      Type: application

  TargetGroup80:
      Type: AWS::ElasticLoadBalancingV2::TargetGroup
      Properties:
        Name: !Sub ${AWS::StackName}-target-group
        Protocol: HTTP
        Port: 80
        TargetType: instance
        VpcId: !Ref VpcId
        Targets:
          - Id: !Ref WebServer 
            Port: 80

  LoadBalancerListener80:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
      - Type: forward
        TargetGroupArn: !Ref TargetGroup80
      LoadBalancerArn: !Ref ElasticLoadBalancer
      Port: 80
      Protocol: HTTP

# Roles for EC2
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
        - !Ref InstanceRole

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${AWS::StackName}-Role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: 'Allow'
          Principal:
            Service:
            - 'ec2.amazonaws.com'
          Action:
          - 'sts:AssumeRole'
      ManagedPolicyArns:
        - !Ref InstancePolicy

  InstancePolicy:
    Type: 'AWS::IAM::ManagedPolicy'
    Properties:
      Path: /
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - 'ssm:*'
              - 'ssmmessages:*'
              - 'ec2messages:*'
            Resource: "*"

